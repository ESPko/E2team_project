<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>마이페이지</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div th:replace="~{/layout/header :: projectheader}"></div>

<main class="container mt-4">
  <div class="row">
    <!-- 왼쪽 프로필 섹션 -->
    <div class="col-md-4">
      <div class="card p-3">
        <div class="text-center">
          <img src="/img/profile.png" alt="profile_img" style="width: 296px; height: 296px;">
        </div>
        <div class="mt-3">
          <p><strong>아이디:</strong> <span th:text="${user.id}"></span></p>
          <p><strong>비밀번호:</strong> <span th:text="${user.password}"></span></p>
          <p><strong>이메일:</strong> <span th:text="${user.email}"></span></p>
          <p><strong>전화번호:</strong> <span th:text="${user.phone}"></span></p>
          <p><strong>가입일:</strong> <span th:text="${user.createDate}"></span></p>
        </div>
      </div>
    </div>

    <!-- 오른쪽 기능 섹션 -->
    <div class="col-md-8">
      <h3>마이페이지</h3>

      <div class="card p-3 mb-3">
        <button class="btn btn-outline-primary w-100" id="change-password">비밀번호 수정</button>

        <div id="password-form" class="mt-3 d-none">
          <label for="new-password" class="form-label">새 비밀번호</label>
          <input type="password" id="new-password" class="form-control" placeholder="새 비밀번호 입력">

          <label for="confirm-password" class="form-label mt-2">비밀번호 확인</label>
          <input type="password" id="confirm-password" class="form-control" placeholder="비밀번호 확인">

          <button class="btn btn-primary mt-3" id="submit-password">비밀번호 변경</button>
        </div>
      </div>

      <div class="card p-3 mb-3">
        <button class="btn btn-outline-primary w-100" id="change-security">휴대폰번호 수정</button>
        <div id="phone-form" class="mt-3 d-none">
          <input type="text" id="new-phone" class="form-control mb-2" placeholder="새 휴대폰번호">
          <button class="btn btn-primary w-100" id="submit-phone">휴대폰번호 변경</button>
        </div>
      </div>

      <div class="alert alert-success d-none" id="success-message">
        수정 후, "수정되었습니다." 팝업 알림
      </div>

      <div class="card p-3">
        <button class="btn btn-primary w-100" id="my-posts">내가 작성한 게시물 (게시글, 댓글, 리뷰)</button>
      </div>
    </div>
  </div>
</main>

<div th:replace="~{/layout/footer :: projectfooter}"></div>

<script>
  $(document).ready(function() {
    // $("#change-password, #change-security").on("click", function() {
    //   $("#success-message").removeClass("d-none");
    //   setTimeout(function() {
    //     $("#success-message").addClass("d-none");
    //   }, 3000);
    // });

      // 비밀번호 수정 폼 토글
      $("#change-password").on("click", function() {
        $("#password-form").toggleClass("d-none").hide().fadeIn();
      });

    $("#change-security").on("click", function() {
      $("#phone-form").toggleClass("d-none");
    });

      // 비밀번호 변경 전송
      $("#submit-password").on("click", function() {
        const newPassword = $("#new-password").val();
        const confirmPassword = $("#confirm-password").val();

        if (newPassword === "" || confirmPassword === "") {
          alert("비밀번호를 입력하세요.");
          return;
        }
        if (newPassword !== confirmPassword) {
          alert("비밀번호가 일치하지 않습니다.");
          return;
        }

        $.ajax({
          type: "POST",
          url: "/user/updatePassword",
          contentType: "application/json",
          data: JSON.stringify({ password: newPassword }),
          success: function(response) {
            alert("수정되었습니다.");
            $("#password-form").addClass("d-none");
            location.reload();
          },
          error: function(xhr) {
            alert("비밀번호 변경에 실패했습니다.");
            console.log(xhr);
          }
        });
      });


    $("#submit-phone").on("click", function() {
      let newPhone = $("#new-phone").val();

      $.ajax({
        type: "POST",
        url: "/user/updatePhone",
        contentType: "application/json",
        data: JSON.stringify({ phone: newPhone }),
        success: function(response) {
          alert("수정되었습니다.");
          $("#phone-form").addClass("d-none");
          location.reload()
        },
        error: function(xhr) {
          alert("휴대폰번호 변경에 실패했습니다.");
          console.log(xhr)
        }
      });
    });

    // 나의 게시물 이동
    $("#my-posts").on("click", function() {
      location.href="/myboard"
    });

  });
</script>

</body>
</html>
