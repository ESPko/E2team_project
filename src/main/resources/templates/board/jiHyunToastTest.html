<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>jiHyunToastTest</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
          integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
          crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
          crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>

</head>
<body>
<form id="boardForm" action="/jiHyunToast/submit" method="post" enctype="multipart/form-data">
  <div id="content">
  </div>
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  <script>
      const editor = new toastui.Editor({
          el: document.querySelector('#content'), // ì—ë””í„°ë¥¼ ì ìš©í•  ìš”ì†Œ (ì»¨í…Œì´ë„ˆ)
          height: '500px',                        // ì—ë””í„° ì˜ì—­ì˜ ë†’ì´ ê°’ (OOOpx || auto)
          initialEditType: 'markdown',            // ìµœì´ˆë¡œ ë³´ì—¬ì¤„ ì—ë””í„° íƒ€ì… (markdown || wysiwyg)
          initialValue: 'ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.',     // ë‚´ìš©ì˜ ì´ˆê¸° ê°’ìœ¼ë¡œ, ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´ ë¬¸ìì—´ í˜•íƒœì—¬ì•¼ í•¨
          previewStyle: 'vertical',

          /* start of hooks */
          hooks: {
              async addImageBlobHook(blob, callback) { // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¡œì§ ì»¤ìŠ¤í…€
                  try {
                      /*
                       * 1. ì—ë””í„°ì— ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ë¥¼ FormData ê°ì²´ì— ì €ì¥
                       *    (ì´ë•Œ, ì»¨íŠ¸ë¡¤ëŸ¬ uploadEditorImage ë©”ì„œë“œì˜ íŒŒë¼ë¯¸í„°ì¸ 'image'ì™€ formDataì— append í•˜ëŠ” key('image')ê°’ì€ ë™ì¼í•´ì•¼ í•¨)
                       */
                      const formData = new FormData();
                      formData.append('image', blob);

                      // 2. FileApiController - uploadEditorImage ë©”ì„œë“œ í˜¸ì¶œ
                      const response = await fetch('/boardImage/image-upload', {
                          method: 'POST',
                          body: formData,
                      });

                      // 3. ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì „ë‹¬ë°›ì€ ë””ìŠ¤í¬ì— ì €ì¥ëœ íŒŒì¼ëª…
                      const filename = await response.text();
                      console.log('ì„œë²„ì— ì €ì¥ëœ íŒŒì¼ëª… : ', filename);

                      // 4. addImageBlobHookì˜ callback í•¨ìˆ˜ë¥¼ í†µí•´, ë””ìŠ¤í¬ì— ì €ì¥ëœ ì´ë¯¸ì§€ë¥¼ ì—ë””í„°ì— ë Œë”ë§
                      const imageUrl = `/boardImage/image-print?filename=${filename}`;
                      callback(imageUrl, 'image alt attribute');

                  } catch (error) {
                      console.error('ì—…ë¡œë“œ ì‹¤íŒ¨ : ', error);
                  }
              }
          }
          /* end of hooks */
      });
  </script>
  <input type="file" name="files" multiple>
  <button type="button" class="toastWrite">ì‘ì„±í•˜ê¸°</button>
  <script>
      $(".toastWrite").on("click", function () {
          $(".toastWrite").on("click", function() {
              const form = document.querySelector("#boardForm");
              const formData = new FormData(form);

              // ğŸŸ¢ ì—ë””í„° ë‚´ìš© ì¶”ê°€
              formData.append("title", "í…ŒìŠ¤íŠ¸ ì œëª©");
              formData.append("contents", editor.getMarkdown());
              formData.append("category", "ììœ ê²Œì‹œíŒ");

              fetch("/jiHyunToast/submit", {
                  method: "POST",
                  body: formData
              })
                  .then(response => response.text())
                  .then(data => {
                      console.log("ì—…ë¡œë“œ ì„±ê³µ:", data);
                      location.href = "/board/list"; // ê²Œì‹œíŒ ëª©ë¡ìœ¼ë¡œ ì´ë™ (í•„ìš” ì‹œ ë³€ê²½)
                  })
                  .catch(error => console.error("ì—…ë¡œë“œ ì‹¤íŒ¨:", error));
          });
      });
  </script>
</form>

</body>
</html>