<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>jiHyunToastTest</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
          integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
          crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
          crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>

</head>
<body>
<form id="boardForm" action="/jiHyunToast/submit" method="post" enctype="multipart/form-data">
  <div id="content">
  </div>
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  <script>
      const editor = new toastui.Editor({
          el: document.querySelector('#content'), // 에디터를 적용할 요소 (컨테이너)
          height: '500px',                        // 에디터 영역의 높이 값 (OOOpx || auto)
          initialEditType: 'markdown',            // 최초로 보여줄 에디터 타입 (markdown || wysiwyg)
          initialValue: '내용을 입력해 주세요.',     // 내용의 초기 값으로, 반드시 마크다운 문자열 형태여야 함
          previewStyle: 'vertical',

          /* start of hooks */
          hooks: {
              async addImageBlobHook(blob, callback) { // 이미지 업로드 로직 커스텀
                  try {
                      /*
                       * 1. 에디터에 업로드한 이미지를 FormData 객체에 저장
                       *    (이때, 컨트롤러 uploadEditorImage 메서드의 파라미터인 'image'와 formData에 append 하는 key('image')값은 동일해야 함)
                       */
                      const formData = new FormData();
                      formData.append('image', blob);

                      // 2. FileApiController - uploadEditorImage 메서드 호출
                      const response = await fetch('/boardImage/image-upload', {
                          method: 'POST',
                          body: formData,
                      });

                      // 3. 컨트롤러에서 전달받은 디스크에 저장된 파일명
                      const filename = await response.text();
                      console.log('서버에 저장된 파일명 : ', filename);

                      // 4. addImageBlobHook의 callback 함수를 통해, 디스크에 저장된 이미지를 에디터에 렌더링
                      const imageUrl = `/boardImage/image-print?filename=${filename}`;
                      callback(imageUrl, 'image alt attribute');

                  } catch (error) {
                      console.error('업로드 실패 : ', error);
                  }
              }
          }
          /* end of hooks */
      });
  </script>
  <input type="file" name="files" multiple>
  <button type="button" class="toastWrite">작성하기</button>
  <script>
      $(".toastWrite").on("click", function () {
          $(".toastWrite").on("click", function() {
              const form = document.querySelector("#boardForm");
              const formData = new FormData(form);

              // 🟢 에디터 내용 추가
              formData.append("title", "테스트 제목");
              formData.append("contents", editor.getMarkdown());
              formData.append("category", "자유게시판");

              fetch("/jiHyunToast/submit", {
                  method: "POST",
                  body: formData
              })
                  .then(response => response.text())
                  .then(data => {
                      console.log("업로드 성공:", data);
                      location.href = "/board/list"; // 게시판 목록으로 이동 (필요 시 변경)
                  })
                  .catch(error => console.error("업로드 실패:", error));
          });
      });
  </script>
</form>

</body>
</html>